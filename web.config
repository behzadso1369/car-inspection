<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Configure IIS to handle Next.js routes with reverse proxy -->
    <rewrite>
      <rules>
        <!-- Handle Next.js static files - serve directly from IIS -->
        <rule name="Next.js Static Files" stopProcessing="true">
          <match url="^/(_next|static|favicon.ico|icon|manifest.webmanifest|sitemap.xml|robots.txt)" />
          <action type="None" />
        </rule>
        
        <!-- Handle public folder assets -->
        <rule name="Public Assets" stopProcessing="true">
          <match url="^/(.*\.(?:jpg|jpeg|gif|png|svg|ico|css|js|woff|woff2|ttf|eot|json|xml|txt))$" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>
        
        <!-- Handle root path (/) - Multiple patterns to ensure it works -->
        <rule name="Next.js Root Path 1" stopProcessing="true">
          <match url="^/?$" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_ACCEPT_ENCODING" value="{HTTP_ACCEPT_ENCODING}" />
            <set name="HTTP_ACCEPT_ENCODING" value="" />
          </serverVariables>
          <action type="Rewrite" url="http://localhost:3000/" />
        </rule>
        
        <!-- Alternative root path rule -->
        <rule name="Next.js Root Path 2" stopProcessing="true">
          <match url="^index\.html?$" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_ACCEPT_ENCODING" value="{HTTP_ACCEPT_ENCODING}" />
            <set name="HTTP_ACCEPT_ENCODING" value="" />
          </serverVariables>
          <action type="Rewrite" url="http://localhost:3000/" />
        </rule>
        
        <!-- Proxy all other requests to Next.js server (SSR) -->
        <rule name="Next.js Proxy" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_ACCEPT_ENCODING" value="{HTTP_ACCEPT_ENCODING}" />
            <set name="HTTP_ACCEPT_ENCODING" value="" />
          </serverVariables>
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
        </rule>
      </rules>
      <outboundRules>
        <!-- Preserve response headers -->
        <rule name="ReverseProxyOutboundRule1" preCondition="ResponseIsHtml1">
          <match filterByTags="A, Form, Img" pattern="^http(s)?://localhost:3000/(.*)" />
          <action type="Rewrite" value="http{R:1}://{HTTP_HOST}/{R:2}" />
        </rule>
        <preConditions>
          <preCondition name="ResponseIsHtml1">
            <add input="{RESPONSE_CONTENT_TYPE}" pattern="^text/html" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>
    
    <!-- Configure HTTP errors -->
    <httpErrors errorMode="Detailed" existingResponse="PassThrough" />
    
    <!-- Enable compression for better performance -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    
    <!-- Disable default document (important for Next.js) -->
    <defaultDocument enabled="false" />
    
    <!-- Remove server header for security -->
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
      </customHeaders>
    </httpProtocol>
    
    <!-- Increase timeout for long-running requests (for reverse proxy) -->
    <asp>
      <applicationPool requestQueueLimit="5000" />
    </asp>
    
    <!-- Enable proxy features (required for reverse proxy) -->
    <proxy enabled="true" />
  </system.webServer>
</configuration>
